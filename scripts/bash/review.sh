#!/usr/bin/env bash
# ä¸‰éå®¡æ ¡ - é™ä½ AI å‘³çš„æ ¸å¿ƒç³»ç»Ÿ

set -e

SCRIPT_DIR=$(dirname "$0")
source "$SCRIPT_DIR/common.sh"

PROJECT_ROOT=$(get_project_root)
MODE="$1"  # content, style, detail
DRAFT_FILE="$2"

# å¦‚æœæ²¡æœ‰æŒ‡å®šè‰ç¨¿ï¼Œä½¿ç”¨æœ€æ–°çš„
if [ -z "$DRAFT_FILE" ]; then
    DRAFT_FILE=$(get_latest_draft)
fi

if [ -z "$DRAFT_FILE" ] || [ ! -f "$DRAFT_FILE" ]; then
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°è‰ç¨¿æ–‡ä»¶"
    echo "ç”¨æ³•: audit.sh <mode> [draftæ–‡ä»¶è·¯å¾„]"
    echo "  mode: content (å†…å®¹å®¡æ ¡) | style (é£æ ¼å®¡æ ¡) | detail (ç»†èŠ‚å®¡æ ¡)"
    exit 1
fi

# éªŒè¯ mode
if [ -z "$MODE" ]; then
    echo "âŒ é”™è¯¯: æœªæŒ‡å®šå®¡æ ¡æ¨¡å¼"
    echo "ç”¨æ³•: audit.sh <mode> [draftæ–‡ä»¶è·¯å¾„]"
    echo "  mode: content (å†…å®¹å®¡æ ¡) | style (é£æ ¼å®¡æ ¡) | detail (ç»†èŠ‚å®¡æ ¡)"
    exit 1
fi

# åˆ›å»ºå®¡æ ¡æ—¥å¿—ç›®å½•
ARTICLE_DIR=$(dirname "$DRAFT_FILE")
AUDIT_LOG="$ARTICLE_DIR/audit-log.md"

# åˆå§‹åŒ–å®¡æ ¡æ—¥å¿—
if [ ! -f "$AUDIT_LOG" ]; then
    cat > "$AUDIT_LOG" << EOF
# å®¡æ ¡è®°å½•

**è‰ç¨¿æ–‡ä»¶**: $(basename "$DRAFT_FILE")
**åˆ›å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')

---

EOF
fi

echo "âœ… è‰ç¨¿æ–‡ä»¶: $DRAFT_FILE"
echo "ğŸ“ å®¡æ ¡æ¨¡å¼: $MODE"
echo ""

# æ˜¾ç¤ºå½“å‰å­—æ•°
WORD_COUNT=$(count_chinese_words "$DRAFT_FILE")
echo "ğŸ“Š å½“å‰å­—æ•°: $WORD_COUNT"
echo ""

case "$MODE" in
    content)
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“‹ ç¬¬ä¸€éå®¡æ ¡: å†…å®¹å®¡æ ¡"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "å…³æ³¨ç»´åº¦:"
        echo "  âœ“ äº‹å®å‡†ç¡®æ€§ - æ•°æ®ã€å¼•ç”¨æ˜¯å¦æ­£ç¡®"
        echo "  âœ“ é€»è¾‘è¿è´¯æ€§ - è®ºè¯æ˜¯å¦æ¸…æ™°æœ‰åŠ›"
        echo "  âœ“ ç»“æ„å®Œæ•´æ€§ - å¼€å¤´ã€æ­£æ–‡ã€ç»“å°¾æ˜¯å¦å®Œæ•´"
        echo "  âœ“ ä¿¡æ¯å¯†åº¦ - æ˜¯å¦æœ‰ç©ºè¯ã€å¥—è¯"
        echo ""
        echo "ğŸ’¡ å®¡æ ¡è¦ç‚¹:"
        echo "   - åˆ é™¤å†—ä½™ä¿¡æ¯"
        echo "   - è¡¥å……ç¼ºå¤±è®ºæ®"
        echo "   - ä¼˜åŒ–é€»è¾‘ç»“æ„"
        ;;
    style)
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ¨ ç¬¬äºŒéå®¡æ ¡: é£æ ¼å®¡æ ¡ (é™ AI å‘³)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "å…³æ³¨ç»´åº¦:"
        echo "  âœ“ åˆ é™¤ AI å¥—è¯ - 'éšç€...å‘å±•'ã€'åœ¨...èƒŒæ™¯ä¸‹'"
        echo "  âœ“ æ‹†è§£ AI å¥å¼ - è¿‡é•¿ã€è¿‡äºå·¥æ•´çš„æ’æ¯”å¥"
        echo "  âœ“ å¢åŠ çœŸå®æ„Ÿ - èå…¥å…·ä½“æ•°å­—ã€æ¡ˆä¾‹ã€ç»†èŠ‚"
        echo "  âœ“ å¼ºåŒ–ä¸ªæ€§åŒ– - åŠ å…¥ä¸ªäººè§‚ç‚¹ã€ç»å†"
        echo ""
        echo "ğŸ’¡ å®¡æ ¡è¦ç‚¹:"
        echo "   - ä½¿ç”¨ text-audit.sh æ£€æµ‹ AI å‘³"
        echo "   - ä¼˜å…ˆæ›¿æ¢ä¸ºä¸ªäººç´ æåº“çš„çœŸå®å†…å®¹"
        echo "   - ç›®æ ‡: AI æ£€æµ‹ç‡ < 30%"
        echo ""
        # è¿è¡Œ AI å‘³æ£€æµ‹
        if [ -f "$SCRIPT_DIR/text-audit.sh" ]; then
            echo "ğŸ” è¿è¡Œ AI å‘³æ£€æµ‹..."
            echo ""
            bash "$SCRIPT_DIR/text-audit.sh" "$DRAFT_FILE" || true
            echo ""
        fi
        ;;
    detail)
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ¨ ç¬¬ä¸‰éå®¡æ ¡: ç»†èŠ‚å®¡æ ¡"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "å…³æ³¨ç»´åº¦:"
        echo "  âœ“ æ ‡ç‚¹ç¬¦å· - ä¸­è‹±æ–‡æ ‡ç‚¹ä½¿ç”¨è§„èŒƒ"
        echo "  âœ“ æ’ç‰ˆæ ¼å¼ - æ®µè½é—´è·ã€åˆ—è¡¨æ ¼å¼"
        echo "  âœ“ ç”¨è¯å‡†ç¡® - é”™åˆ«å­—ã€åŒéŸ³å­—"
        echo "  âœ“ èŠ‚å¥æŠŠæ§ - å¥å­é•¿çŸ­æ­é…"
        echo ""
        echo "ğŸ’¡ å®¡æ ¡è¦ç‚¹:"
        echo "   - æœ€åçš„æŠ›å…‰å·¥ä½œ"
        echo "   - ç¡®ä¿å‘å¸ƒå‰å®Œç¾"
        ;;
    *)
        echo "âŒ é”™è¯¯: æœªçŸ¥çš„å®¡æ ¡æ¨¡å¼: $MODE"
        echo "å¯ç”¨æ¨¡å¼: content, style, detail"
        exit 1
        ;;
esac

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ æ¥ä¸‹æ¥:"
echo "   1. AI å°†åŸºäºä»¥ä¸Šç»´åº¦å®¡æ ¡æ–‡ç« "
echo "   2. ä¿®æ”¹å»ºè®®å°†è®°å½•åˆ° $AUDIT_LOG"
echo "   3. å®Œæˆåç»§ç»­ä¸‹ä¸€éå®¡æ ¡æˆ–å‘å¸ƒ"
echo ""

# è®°å½•å®¡æ ¡å¼€å§‹
echo "" >> "$AUDIT_LOG"
echo "## å®¡æ ¡: $MODE ($(date '+%Y-%m-%d %H:%M:%S'))" >> "$AUDIT_LOG"
echo "" >> "$AUDIT_LOG"

# è¾“å‡ºä¿¡æ¯ä¾› AI ä½¿ç”¨
output_json "{\"draft_file\": \"$DRAFT_FILE\", \"mode\": \"$MODE\", \"word_count\": $WORD_COUNT, \"audit_log\": \"$AUDIT_LOG\"}"
